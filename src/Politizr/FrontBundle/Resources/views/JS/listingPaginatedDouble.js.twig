<script>
    // Initialisation de la liste
    $(document).ready(function () {
        listing();
    });

    // Gestion de l'ordonnancement
    $("body").on("click", "a.order", function(e) {
        e.preventDefault();
        $(this).tab('show');
        listing();
    });

    // Gestion des filtres
    $("body").on("change", ".filter", function(e) {
        e.preventDefault();
        listing();
    });

    // Page suivante
    $("body").on("click", "a[action='paginate-next-user']", function(e) {
        listingUser(false, $(this).attr('offset'));
    });
    $("body").on("click", "a[action='paginate-next-debate']", function(e) {
        listingDebate(false, $(this).attr('offset'));
    });

    // Initialisation de la double liste paginée
    function listing(init) {
        console.log('*** listing');

        init = (typeof init === "undefined") ? true : init;
        console.log(init);

        var datas = getListingDatas();

        listingUser(init);
        listingDebate(init);
    }

    // Liste paginée des users
    function listingUser(init, offset) {
        console.log('*** listingUser');
        console.log(init);
        console.log(offset);

        var datas = getListingDatas(offset);

        $.ajax({
            type: 'POST',
            url: "{{ path(RouteUserName) }}",
            data: datas,
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#infoBoxHolder.boxError.notifBoxText').html(data['error']);
                    $('#infoBoxHolder.boxError').show();
                } else {
                    $('#scroll-nav-user').remove();
                     if (init) {
                        $('#list-content-user').html(data['html']);
                    } else {
                        $('#list-content-user').append(data['html']);
                    }
                }
                $('#ajaxGlobalLoader').hide();
            }
        });    
    }

    // Liste paginée des débats
    function listingDebate(init, offset) {
        console.log('*** listingDebate');
        console.log(init);
        console.log(offset);

        var datas = getListingDatas(offset);

        $.ajax({
            type: 'POST',
            url: "{{ path(RouteDebateName) }}",
            data: datas,
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#infoBoxHolder.boxError.notifBoxText').html(data['error']);
                    $('#infoBoxHolder.boxError').show();
                } else {
                    $('#scroll-nav-debate').remove();
                    if (init) {
                        $('#list-content-debate').html(data['html']);
                    } else {
                        $('#list-content-debate').append(data['html']);
                    }
                }
                $('#ajaxGlobalLoader').hide();
            }
        });    
    }

    // Récupération des arguments ordonnancement / filtres / supplémentaires
    function getListingDatas(offset) {
        console.log('*** getListingDatas');

        offset = (typeof offset === "undefined") ? 0 : offset;
        console.log(offset);

        // Récupération de l'ordonnancement en cours
        order = $("#paginated-double-list li.active").children().attr('order');
        order = (typeof order === "undefined") ? null : order;
        console.log(order);

        // Récupération du form des filtres
        var datas = $('#list-filter').serializeArray();
        console.log(datas);

        datas.push({name: 'order', value: order});
        datas.push({name: 'offset', value: offset});

        // Récupération d'arguments JS supplémentaires
        var additionalDatas = $('#paginated-double-list').data();
        $.each(additionalDatas, function(index, element) {
            datas.push({name: index, value: element});
        });

        console.log(datas);
        
        return datas;        
    }


</script>
