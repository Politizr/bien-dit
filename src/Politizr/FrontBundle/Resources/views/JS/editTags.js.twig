{# Gestion code doublon / inscriptionStep3.html.twig > oui / non à mutualiser? #}
<script>
    // **************************** //
    //      Gestion des accents
    // **************************** //
    {% include 'PolitizrFrontBundle:JS:accentMap.js.twig' %}
    var normalize = function( term ) {
        var ret = "";
        for ( var i = 0; i < term.length; i++ ) {
            ret += accentMap[ term.charAt(i) ] || term.charAt(i);
        }
        return ret;
    };

    // **************************** //
    //      Initialisation
    // **************************** //
    $(document).ready(function () {
        // *************************************************** //
        //    Initialisation des données autocomplete
        // *************************************************** //

        var nbZones = {{ nbZones }};
        console.log('nbZones = '+nbZones);

        for (i = 1; i <= nbZones; i++ ) {
            var tagTypeId = $('#edit-tag-zone-'+i).children('.tagsAttr').eq(0).attr('tag-type-id');
            console.log('tagTypeId = '+tagTypeId);

            $.ajax({
                type: 'POST',
                url: "{{ path('GetTags') }}",
                data: { 'tagTypeId': tagTypeId, 'zoneId': i },
                dataType: 'json',
                // context: $('#edit-tag-zone-'+i),
                {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
                success: function(data) {
                    $('#ajax-loader').hide();
                    if (data['error']) {
                        $('.alert-danger-msg').html(data['error']);
                        $('.alert.alert-danger').show();
                    } else {
                        var availableTags = [];
                        $.each( data['tags'], function( key, val ) {
                            var item = [];
                            item['label'] = val.title;
                            item['value'] = val.id;

                            availableTags.push(item);
                        });

                        var zoneId = data['zoneId'];

                        // http://api.jqueryui.com/autocomplete/
                        $('#edit-tag-zone-'+zoneId).children('.selectedTag').eq(0).autocomplete({
                        // $('.selectedTag').autocomplete({
                            source: function( request, response ) {
                                var matcher = new RegExp( $.ui.autocomplete.escapeRegex( request.term ), "i" );
                                response( $.grep( availableTags, function( value ) {
                                    value = value.label || value.value || value;
                                    return matcher.test( value ) || matcher.test( normalize( value ) );
                                }));
                            },
                            select: function (event, ui) {
                                event.preventDefault();

                                // Affichage de la sélection
                                $('#edit-tag-zone-'+zoneId).children('.selectedTag').eq(0).val(ui.item.label);     // display the selected text
                                $('#edit-tag-zone-'+zoneId).children('.selectedTagID').eq(0).val(ui.item.value);   // save selected id to hidden input
                            }
                        });
                    }
                }
            })
        }
    });

    // clic ajout nouveau tag
    $("body").on("click", "button[action='addTag']", function() {
        console.log('click addTag');

        var tagTitle = $(this).siblings('.selectedTag').eq(0).val();
        var tagId = $(this).siblings('.selectedTagID').eq(0).val();
        var tagTypeId = $(this).siblings('.tagsAttr').eq(0).attr('tag-type-id');
        var objectId = $(this).siblings('.tagsAttr').eq(0).attr('object-id');
        var newTag = $(this).siblings('.tagsAttr').eq(0).attr('new-tag');
        var addUrl = $(this).siblings('.tagsAttr').eq(0).attr('path');

        console.log('title = ' + tagTitle);
        console.log('id = ' + tagId);
        console.log('type = ' + tagTypeId);
        console.log('objectId = ' + objectId);
        console.log('newTag = ' + newTag);
        console.log('url = ' + addUrl);

        tag = tagTitle.trim();
        if (tag === '') {
            return false;
        }

        // Ajout du nouveau tag
        $.ajax({
            type: 'POST',
            url: addUrl,
            data: { 'tagTitle': tagTitle, 'tagId': tagId, 'tagTypeId': tagTypeId, 'objectId': objectId, 'newTag': newTag },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            context: this,
            success: function(data) {
                $('#ajax-loader').hide();
                if (data['error']) {
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    $('#ajaxLoader').hide();

                    if (data['created']) {
                        // Association du nouveau tag aux tags suivis
                        $(this).siblings('.displayTagsZone').eq(0).append(data['htmlTag']);
                    }

                    // Init inputs tag
                    $(this).siblings('.selectedTag').eq(0).val('');
                    $(this).siblings('.selectedTagID').eq(0).val('');
                }
            }
        });
    });

    // clic suppression tag
    $("body").on("click", "a[action='deleteTag']", function() {
        console.log('click deleteTag');

        var tagId = $(this).attr('tag-id');
        var objectId = $(this).attr('object-id');;
        var deleteUrl = $(this).attr('path');

        console.log('tagId = ' + tagId);
        console.log('objectId = ' + objectId);
        console.log('deleteUrl = ' + deleteUrl);

        $.ajax({
            type: 'POST',
            url: deleteUrl,
            data: { 'objectId': objectId, 'tagId': tagId },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            context: $(this).parent(),
            success: function(data) {
                $('#ajax-loader').hide();
                if (data['error']) {
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    $('#ajaxLoader').hide();

                    $(this).remove();
                }
            }
        });
    });

</script>
