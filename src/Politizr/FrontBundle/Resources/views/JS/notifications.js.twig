<script>
    // initialisation des notifications
    $(function() {
        notificationsCheck();
    })

    // ouverture/fermeture box notifications
    $("body").on("click", "[action='linkNotifications']", function() {
        $('#notifications').slideDown('fast');
        $('html, body').animate({
            scrollTop: $("body").offset().top
        }, 'fast');
    });
    $("body").on("click", ".notifClose", function() {
        $('#notifications').slideUp('fast');
    });
    

    // Regular function with arguments
    function notificationsCheck(){
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationsLoad') }}",
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
                $('#ajaxGlobalLoader').hide();

                // MAJ compteur
                $('#notif-counter').html(data['nb']);

                // MAJ listing des notifs
                $('#notif-list').html(data['html']);
            }
        });

        // Rappel toutes les 60 secondes
        setTimeout(function(){
            notificationsCheck();
        }, 60000);
    }

    // check une notification
    $("body").on("click", "i[action='notification-check']", function(e) {
        console.log('*** click i notification-check');

        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationCheck') }}",
            context: $(this).closest('tr'),
            data: { 'subjectId': $(this).closest('span').attr('subject-id') },
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
                $(this).attr('class', '');
                $('#notif-counter').html(parseInt($('#notif-counter').text()) - 1);

                $('#ajaxGlobalLoader').hide();
            }
        });

    })
    
    $("body").on("click", "a[action='notification-check']", function(e) {
        console.log('*** click a notification-check');

        e.preventDefault();
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationCheck') }}",
            context: this,
            data: { 'subjectId': $(this).closest('span').attr('subject-id') },
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
                window.location = $(this).attr('href');
            }
        });

    })
    
    // check / uncheck toutes les notifications
    $("body").on("click", "div[action='notification-check-all']", function(e) {
        console.log('*** click notification-check-all');

        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationsCheckAll') }}",
            context: $(this).closest('table'),
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
                // MAJ du style
                $('.notifHighlight').attr('class', '');

                // MAJ du compteur
                $('#notif-counter').html('-');
                $('#ajaxGlobalLoader').hide();
            }
        });

    })
    
</script>