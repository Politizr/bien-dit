<script>
	// initialisation des notifications
	$(function() {
        notificationsCheck();
	})

    // Regular function with arguments
    function notificationsCheck(){
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationsLoad') }}",
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
                $('#ajax-loader').hide();

                // MAJ compteur
                $('#notif-counter').html(data['nb']);

                // http://getbootstrap.com/javascript/#popovers
                // $('[data-toggle=popover]').popover('destroy');
                $('[data-toggle=popover]').popover({
                    container: 'body',
                    placement: 'bottom',
                    trigger: 'click',
                    html: 'true',
                    content: function (){return data['html']},
                });

                $(".popover-content").html(data['html'])

            }
        });

        // Rappel toutes les 60 secondes
        setTimeout(function(){
            notificationsCheck();
        }, 60000);
    }    

	// check une notification
	$("body").on("click", "i[action='notification-check']", function(e) {
        console.log('*** click i notification-check');

        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationCheck') }}",
            context: $(this).closest('tr'),
            data: { 'subjectId': $(this).closest('tr').attr('subject-id') },
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
           		$(this).attr('class', '');
           		$('#notif-counter').html(parseInt($('#notif-counter').text()) - 1);

                $('#ajax-loader').hide();
            }
        });

    })
	
	$("body").on("click", "a[action='notification-check']", function(e) {
        console.log('*** click a notification-check');

        e.preventDefault();
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationCheck') }}",
            context: this,
            data: { 'subjectId': $(this).closest('tr').attr('subject-id') },
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
           		window.location = $(this).attr('href');
            }
        });

    })
	
	// check / uncheck toutes les notifications
	$("body").on("click", "a[action='notification-check-all']", function(e) {
        console.log('*** click notification-check-all');

        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : "{{ path('NotificationsCheckAll') }}",
            context: $(this).closest('table'),
            {% include 'PolitizrFrontBundle:JS:ajaxErrorNoLoader.js.twig' %}
            success: function(data) {
               	// MAJ du style des lignes du tableau
				$('#notifTable tr').not('thead tr').attr('class', '');

	            // MAJ du compteur
               	$('#notif-counter').html('-');
                $('#ajax-loader').hide();
            }
        });

    })
	
</script>