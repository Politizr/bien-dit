<script>
    // Gestion du type débat / user
    $("body").on("change", ".type", function(e) {
        // maj de l'url cible de la liste
        $('#paginatedList').attr('url', $(this).attr('url'));
        
        // réinitialisation des filtres & de la liste
        initListing($(this).val(), $('#paginatedList').attr('withFilters'));
    });

    // Gestion de l'ordonnancement
    $("body").on("change", ".order", function(e) {
        e.preventDefault();
        listing();
    });

    // Gestion des filtres
    $("body").on("change", ".filter", function(e) {
        e.preventDefault();
        listing();
    });

    // Page suivante
    $("body").on("click", "[action='paginate-next']", function(e) {
        listing(false, $(this).attr('offset'));
    });

    // imgLiquid onSuccess
    function imgLiquidOnSuccess() {
        // full size image in debate summary 
        $(".postSummary").imgLiquid({
            fill: true,
            horizontalAlign: "center",
            verticalAlign: "center"
        });
    }

    // Chargement paginé de la liste
    function listing(init, offset) {
        console.log('*** listing');
        console.log(init);
        console.log(offset);

        init = (typeof init === "undefined") ? true : init;
        offset = (typeof offset === "undefined") ? 0 : offset;
        
        // Récupération de l'ordonnancement en cours
        var order = $('#listOrder').serializeArray();
        console.dir(order);

        // Récupération du form des filtres
        var filters = $('#listFilter').serializeArray();
        console.dir(filters);

        // Concaténation des attributs
        var datas = $.merge(order, filters);
        datas.push({name: 'offset', value: offset});

        console.dir(datas);

        // Récupération d'arguments JS supplémentaires
        // var additionalDatas = $('#paginatedList').data();
        // console.log('additionalDatas');
        // console.log(additionalDatas);
        // $.each(additionalDatas, function(index, element) {
        //     datas.push({name: index, value: element});
        // });

        // Récupération de l'URL de la liste
        var url = $('#paginatedList').attr('url');

        $.ajax({
            type: 'POST',
            url: url,
            data: datas,
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#infoBoxHolder.boxError.notifBoxText').html(data['error']);
                    $('#infoBoxHolder.boxError').show();
                } else {
                    $('#scrollNav').remove();
                    if (init) {
                        $('#resultContent').html(data['html']);
                    } else {
                        $('#resultContent').append(data['html']);
                    }

                    imgLiquidOnSuccess();
                }
                $('#ajaxGlobalLoader').hide();
            }
        });
    }

    // 
    /**
     * Initialisation des filtres & de la liste
     *
     * @param string type   debate | user
     * @param string withFilters  true | false
     */
    function initListing(type, withFilters) {
        console.log('*** initListing');
        console.log(type);
        console.log(withFilters);

        type = (typeof type === "undefined") ? 'debate' : type;
        withFilters = (typeof withFilters === "undefined") ? 'true' : withFilters;

        $('#resultContent').html('');

        if ('false' == withFilters) {
            // initialisation de la liste
            listing();
        } else {
            // chargement des filtres associé au type + initialisation de la liste
            $.ajax({
                type: 'POST',
                url: "{{ path('Filters') }}",
                data: { 'type': type },
                dataType: 'json',
                {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
                success: function(data) {
                    if (data['error']) {
                        $('#infoBoxHolder.boxError.notifBoxText').html(data['error']);
                        $('#infoBoxHolder.boxError').show();
                    } else {
                        $('#listOrder').html(data['listOrder']);
                        $('#listFilter').html(data['listFilter']);

                        listing();
                    }
                    $('#ajaxGlobalLoader').hide();
                }
            });
        }
    }


</script>
