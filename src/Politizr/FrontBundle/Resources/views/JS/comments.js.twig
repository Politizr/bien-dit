<script>
    // **************************** //
    //      Initialisation
    // **************************** //
    $(document).ready(function () {
        $('.comments').hide();
    });


    // Fermeture commentaires
    $("body").on("click", "[action='closeComments']", function(e) {
        console.log('*** click closeComments');

        context = $(this).closest('.paragraph').find('.comments');
        context.slideUp();
        context.html('');
    });


    // **************************** //
    //      AJAX
    // **************************** //

    // affichage des commentaires par paragraphe
    $("body").on("click", "[action='comments']", function(e) {
        console.log('*** click comments');

        // Fermeture préalable de tous les paragraphes ouverts
        context = $('.comments').slideUp().html('');

        var context = $(this).closest('.paragraph');
        $.ajax({
            type: 'POST',
            url: "{{ path('Comments') }}",
            context: context,
            data: { 'subjectId': $(this).attr('subjectId'), 'type':  $(this).attr('type'), 'noParagraph': $(this).attr('noParagraph') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                $('#ajaxGlobalLoader').hide();
                if (data['error']) {
                    $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                    $('#infoBoxHolder .boxError').show();
                } else {
                    $(this).find('.comments').html(data['html']).slideDown();
                    $(this).find('.counter').html(data['counter']);
                }
            }
        });
    });

    // création d'un commentaire
    $("body").on("click", "input[action='createComment']", function(e) {
        console.log('*** click createComment');
        
        var context = $(this).closest('.paragraph');
        var localLoader = $(this).prev('.ajaxLoader');

        $.ajax({
            type: 'POST',
            url: "{{ path('CommentNew') }}",
            context: context,
            data: $("#formCommentNew").serialize(),
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxErrorLocalLoader.js.twig' %}
            success: function(data) {
                localLoader.hide();
                if (data['error']) {
                    $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                    $('#infoBoxHolder .boxError').show();
                } else {
                    $(this).find('.comments').html(data['html']).slideDown();
                    $(this).find('.commentsCounter').html(data['counter']);

                    // $("#formCommentNew").trigger("reset");
                    $("#comment_description").val("");
                }
            }
        });

    });

    // ajustement de la taille du textarea de saisie d'un commentaire en fonction de la saisie en cours
    $("body").on('change keyup keydown paste cut', 'textarea', function () {
        $(this).height(0).height(this.scrollHeight);                    
    }).find('textarea').change(); 

</script>
