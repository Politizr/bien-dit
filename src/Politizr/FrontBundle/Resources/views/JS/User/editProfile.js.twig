<script>
    // JCF forms styling
    $(function() {
        jcf.replaceAll();
    });

    // Update user
    $("body").on("click", "[action='userProfileUpdate']", function(e, mode) {
        console.log('*** click user profile update');
        console.log(mode);

        var subtitle = subtitleEditor.serialize();
        var biography = biographyEditor.serialize();

        console.log(subtitle['element-0']['value']);
        console.log(biography['element-0']['value']);

        $('#user_subtitle').val(subtitle['element-0']['value']);
        $('#user_biography').val(biography['element-0']['value']);
     
        var xhrPath = "{% include 'PolitizrFrontBundle:Navigation\\Xhr:_xhrPath.html.twig' with {
            'xhrRoute': 'ROUTE_USER_PROFILE_UPDATE',
            'xhrService': 'user',
            'xhrMethod': 'userProfileUpdate',
            'xhrType': 'RETURN_BOOLEAN',
            } only %}";

        if (mode === 'silence') {
            // sauvegarde silencieuse
            $.ajax({type: 'POST', url : xhrPath, data: $("#formUserProfileUpdate").serialize() });
        } else {
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url : xhrPath,
                data: $("#formUserProfileUpdate").serialize(),
                {% include 'PolitizrFrontBundle:JS:_ajaxError.js.twig' %}
                success: function(data) {
                    $('#ajaxGlobalLoader').hide();
                    if (data['error']) {
                        $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                        $('#infoBoxHolder .boxError').show();
                    } else {
                        $('#infoBoxHolder .boxSuccess .notifBoxText').html('Objet bien enregistré!');
                        $('#infoBoxHolder .boxSuccess').show();
                    }
                }
            });
        }

        return false;
    });


    // Update current organization
    $("body").on("change", "select[action='organizationUpdate']", function(e) {
        console.log('*** change select organization');

        var xhrPath = "{% include 'PolitizrFrontBundle:Navigation\\Xhr:_xhrPath.html.twig' with {
            'xhrRoute': 'ROUTE_USER_ORGA_UPDATE',
            'xhrService': 'user',
            'xhrMethod': 'orgaProfileUpdate',
            'xhrType': 'RETURN_BOOLEAN',
            } only %}";

        $.ajax({
            type: 'POST',
            dataType: 'json',
            url : xhrPath,
            data: $("#formUserOrganizationUpdate").serialize(),
            {% include 'PolitizrFrontBundle:JS:_ajaxError.js.twig' %}
            success: function(data) {
                $('#ajaxGlobalLoader').hide();
                if (data['error']) {
                    $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                    $('#infoBoxHolder .boxError').show();
                } else {
                    $('#infoBoxHolder .boxSuccess .notifBoxText').html('Organisation bien enregistrée.');
                    $('#infoBoxHolder .boxSuccess').show();
                }
            }
        });
    });

    // MAJ des affinités politiques
    // @todo dead code / relancer rossier sur le sujet
    $("body").on("click", "[action='affinities-update']", function(e) {
        console.log('*** click affinities-update');

        var xhrPath = "{% include 'PolitizrFrontBundle:Navigation\\Xhr:_xhrPath.html.twig' with {
            'xhrRoute': 'ROUTE_USER_AFFINITIES_UPDATE',
            'xhrService': 'user',
            'xhrMethod': 'affinitiesProfile',
            'xhrType': 'RETURN_BOOLEAN',
            } only %}";

        $.ajax({
            type: 'POST',
            url: xhrPath,
            data: $('#form-affinities-update').serialize(),
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:_ajaxError.js.twig' %}
            success: function(data) {
                $('#ajaxGlobalLoader').hide();
                if (data['error']) {
                    $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                    $('#infoBoxHolder .boxError').show();
                } else {
                    $('#infoBoxHolder .boxSuccess .notifBoxText').html('Affinités mises à jour.');
                    $('#infoBoxHolder .boxSuccess').show();
                }
            }
        });
    });

    // Mandate creation
    $("body").on("click", "[action='addNewMandate']", function(e) {
        $('#newMandate').slideDown("slow");
    });

    $("body").on("click", "[action='cancelNewMandate']", function(e) {
        $('#newMandate').slideUp("slow");
    });

    $("body").on("click", "[action='mandateCreate']", function(e) {
        console.log('*** click mandateCreate');

        var xhrPath = "{% include 'PolitizrFrontBundle:Navigation\\Xhr:_xhrPath.html.twig' with {
            'xhrRoute': 'ROUTE_USER_MANDATE_CREATE',
            'xhrService': 'user',
            'xhrMethod': 'mandateProfileCreate',
            'xhrType': 'RETURN_HTML',
            } only %}";

        $.ajax({
            type: 'POST',
            url: xhrPath,
            data: $("#formMandateCreate").serialize(),
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:_ajaxError.js.twig' %}
            success: function(data) {
                $('#ajaxGlobalLoader').hide();
                if (data['error']) {
                    $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                    $('#infoBoxHolder .boxError').show();
                } else {
                    $('#infoBoxHolder .boxSuccess .notifBoxText').html('Mandat bien enregistré.');
                    $('#infoBoxHolder .boxSuccess').show();

                    $('#myMandate').html(data['html']);
                    
                    // JCF forms styling
                    jcf.replaceAll();

                    // clear form & slide up
                    $('#formMandateCreate')[0].reset();
                    $('#newMandate').slideUp("slow");
                }
            }
        });
    });

    // Mandate update
    $("body").on("click", "[action='mandateUpdate']", function(e) {
        console.log('*** click mandateUpdate');

        var xhrPath = "{% include 'PolitizrFrontBundle:Navigation\\Xhr:_xhrPath.html.twig' with {
            'xhrRoute': 'ROUTE_USER_MANDATE_UPDATE',
            'xhrService': 'user',
            'xhrMethod': 'mandateProfileUpdate',
            'xhrType': 'RETURN_HTML',
            } only %}";

        $.ajax({
            type: 'POST',
            url: xhrPath,
            data: $(this).closest('#formMandateUpdate').serialize(),
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:_ajaxError.js.twig' %}
            success: function(data) {
                $('#ajaxGlobalLoader').hide();
                if (data['error']) {
                    $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                    $('#infoBoxHolder .boxError').show();
                } else {
                    $('#infoBoxHolder .boxSuccess .notifBoxText').html('Mandat mis à jour.');
                    $('#infoBoxHolder .boxSuccess').show();
                }
            }
        });
    });

    // Mandate deletion
    $("body").on("click", "[action='mandateDelete']", function(e) {
        console.log('*** click mandateDelete');

        var xhrPath = "{% include 'PolitizrFrontBundle:Navigation\\Xhr:_xhrPath.html.twig' with {
            'xhrRoute': 'ROUTE_USER_MANDATE_DELETE',
            'xhrService': 'user',
            'xhrMethod': 'mandateProfileDelete',
            'xhrType': 'RETURN_BOOLEAN',
            } only %}";
        var subjectId = $(this).attr('subjectId');
        console.log('subjectId = ' + subjectId);

        var confirmMsg = "Êtes-vous sûr de vouloir supprimer ce mandat?";
        smoke.confirm(confirmMsg, function(e) {
            if (e) {
                $.ajax({
                    type: 'POST',
                    url: xhrPath,
                    data: { 'id': subjectId },
                    context: $(this).closest('.editMandateItem'),
                    dataType: 'json',
                    {% include 'PolitizrFrontBundle:JS:_ajaxError.js.twig' %}
                    success: function(data) {
                        $('#ajaxGlobalLoader').hide();
                        if (data['error']) {
                            $('#infoBoxHolder .boxError .notifBoxText').html(data['error']);
                            $('#infoBoxHolder .boxError').show();
                        } else {
                            $('#infoBoxHolder .boxSuccess .notifBoxText').html('Mandat supprimé.');
                            $('#infoBoxHolder .boxSuccess').show();

                            $(this).closest('.editMandateItem').hide();
                        }
                    }
                });
            }
        }, {
            ok: "Supprimer",
            cancel: "Annuler"
            // classname: "custom-class",
            // reverseButtons: true
        });
    });

</script>