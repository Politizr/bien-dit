<script>
    // TODO > refonte check gestion dans l'admin, code à simplifier et à mutualiser + bootstrap

    // **************************** //
    //      Gestion des accents
    // **************************** //
    {% include 'PolitizrFrontBundle:JS:accentMap.js.twig' %}
    var normalize = function( term ) {
        var ret = "";
        for ( var i = 0; i < term.length; i++ ) {
            ret += accentMap[ term.charAt(i) ] || term.charAt(i);
        }
        return ret;
    };

    // **************************** //
    //      Initialisation
    // **************************** //
    $(document).ready(function () {
        // *************************************************** //
        //    Initialisation des données pour le profil et le suivi
        // *************************************************** //

        // Gestion de l'initialisation des tags géo & des zones permettant leur sélection
        $.ajax({
            type: 'POST',
            url: "{{ path('GetPTags') }}",
            data: { 'pTTagTypeId': $('#profile-choose-geo-zone').attr('pTTagTypeId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    var availableGeoTags = [];
                    $.each( data['pTags'], function( key, val ) {
                        var item = [];
                        item['label'] = val.title;
                        item['value'] = val.id;

                        availableGeoTags.push(item);
                    });

                    // MAJ du pavé profil géo
                    // http://api.jqueryui.com/autocomplete/
                    $("#profile-choose-geo").autocomplete({
                        source: function( request, response ) {
                            var matcher = new RegExp( $.ui.autocomplete.escapeRegex( request.term ), "i" );
                            response( $.grep( availableGeoTags, function( value ) {
                                value = value.label || value.value || value;
                                return matcher.test( value ) || matcher.test( normalize( value ) );
                            }));
                        },
                        select: function (event, ui) {
                            event.preventDefault();

                            // Affichage de la sélection
                            $("#profile-choose-geo").val(ui.item.label);     // display the selected text
                            $("#profile-choose-geo-id").val(ui.item.value);   // save selected id to hidden input

                            // Inscription en BDD
                            addSelectedTag(ui.item.value, $("#profile-choose-geo-zone").attr('addUrl'), '#profile-selected-geo-zone');

                            // Suppression de l'affichage
                            $("#profile-choose-geo").val('');
                            $("#profile-choose-geo-id").val('');
                        }
                    });

                    // MAJ du pavé suivi géo
                    $("#follow-choose-geo").autocomplete({
                        source: function( request, response ) {
                            var matcher = new RegExp( $.ui.autocomplete.escapeRegex( request.term ), "i" );
                            response( $.grep( availableGeoTags, function( value ) {
                                value = value.label || value.value || value;
                                return matcher.test( value ) || matcher.test( normalize( value ) );
                            }));
                        },
                        select: function (event, ui) {
                            event.preventDefault();

                            // Affichage de la sélection
                            $("#follow-choose-geo").val(ui.item.label);     // display the selected text
                            $("#follow-choose-geo-id").val(ui.item.value);   // save selected id to hidden input

                            // Inscription en BDD
                            addSelectedTag(ui.item.value, $("#follow-choose-geo-zone").attr('addUrl'), '#follow-selected-geo-zone');

                            // Suppression de l'affichage
                            $("#follow-choose-geo").val('');
                            $("#follow-choose-geo-id").val('');
                        }
                    });
                }
            }
        })

        // Gestion de l'initialisation des tags thème & des zones permettant leur sélection
        $.ajax({
            type: 'POST',
            url: "{{ path('GetPTags') }}",
            data: { 'pTTagTypeId': $('#follow-choose-theme-zone').attr('pTTagTypeId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    var availableThemeTags = [];
                    $.each( data['pTags'], function( key, val ) {
                        var item = [];
                        item['label'] = val.title;
                        item['value'] = val.id;

                        availableThemeTags.push(item);
                    });

                    // MAJ du pavé suivi thème
                    $("#follow-choose-theme").autocomplete({
                        source: function( request, response ) {
                            var matcher = new RegExp( $.ui.autocomplete.escapeRegex( request.term ), "i" );
                            response( $.grep( availableThemeTags, function( value ) {
                                value = value.label || value.value || value;
                                return matcher.test( value ) || matcher.test( normalize( value ) );
                            }));
                        },
                        select: function (event, ui) {
                            event.preventDefault();

                            // Affichage de la sélection
                            $("#follow-choose-theme").val(ui.item.label);     // display the selected text
                            $("#follow-choose-theme-id").val(ui.item.value);   // save selected id to hidden input

                            // Inscription en BDD
                            addSelectedTag(ui.item.value, $("#follow-choose-theme-zone").attr('addUrl'), '#follow-selected-theme-zone');

                            // Suppression de l'affichage
                            $("#follow-choose-theme").val('');
                            $("#follow-choose-theme-id").val('');
                        }
                    });
                }
            }
        })

        // Rendu des tags existants
        // MAJ du pavé profil géo
        $.ajax({
            type: 'POST',
            url: "{{ path('GetPUTaggedTPTags') }}",
            data: { 'pTTagTypeId': $('#profile-selected-geo-zone').attr('pTTagTypeId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert.alert-danger').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    console.log('success');

                    $('#profile-selected-geo-zone').append(data['htmlTags']);
                }
            }            
        })

        // MAJ du pavé suivi géo
        $.ajax({
            type: 'POST',
            url: "{{ path('GetPUFollowTPTags') }}",
            data: { 'pTTagTypeId': $('#follow-selected-geo-zone').attr('pTTagTypeId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    console.log('success');

                    $('#follow-selected-geo-zone').append(data['htmlTags']);
                }
            }            
        })

        // MAJ du pavé suivi theme
        $.ajax({
            type: 'POST',
            url: "{{ path('GetPUFollowTPTags') }}",
            data: { 'pTTagTypeId': $('#follow-selected-theme-zone').attr('pTTagTypeId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    console.log('success');

                    $('#follow-selected-theme-zone').append(data['htmlTags']);
                }
            }            
        })


    });

    /**
     * Appel Ajax ajouté un tag au user courant et mettant à jour la zone affichant les tags courant.
     * Choix de l'URL pour association en mode "profil" ou "suivi"
     */
    var addSelectedTag = function( pTagId, url, resultZoneId ) {
        console.log('addSelectedGeoID');
        console.log('pTagId = ' + pTagId);
        console.log('url = ' + url);
        console.log('resultZoneId = ' + resultZoneId);

        $.ajax({
            type: 'POST',
            url: url,
            data: { 'pTagId': pTagId },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    console.log('success');

                    $(resultZoneId).append(data['htmlTag']);
                }
            }
        });
    }

    // clic suppression tag
    $("body").on("click", "#removeTag", function() {
        console.log('click #removeTag');
        console.log('pTagId = ' + $(this).parent().attr('pTagId'));

        $.ajax({
            type: 'POST',
            url: $(this).attr('removeUrl'),
            data: { 'pTagId': $(this).parent().attr('pTagId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            context: $(this).parent(),
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    $('#ajax-loader').hide();

                    $(this).remove();
                }
            }
        });
    });

    // clic ajout nouveau tag
    $("body").on("click", "#add-new-tag", function() {
        console.log('click #add-new-tag');
        console.log('title = ' + $('#follow-choose-theme').val());
        console.log('pTTagTypeId = ' + $('#follow-choose-theme-zone').attr('pTTagTypeId'));

        newTag = $('#follow-choose-theme').val().trim();
        if (newTag === '') {
            return false;
        }

        // Ajout du nouveau tag
        $.ajax({
            type: 'POST',
            url: "{{ path('AddNewPTag') }}",
            data: { 'title': $('#follow-choose-theme').val(), 'pTTagTypeId': $('#follow-choose-theme-zone').attr('pTTagTypeId') },
            dataType: 'json',
            {% include 'PolitizrFrontBundle:JS:ajaxError.js.twig' %}
            context: $(this).parent(),
            success: function(data) {
                if (data['error']) {
                    $('#ajax-loader').hide();
                    $('.alert-danger-msg').html(data['error']);
                    $('.alert.alert-danger').show();
                } else {
                    $('#ajax-loader').hide();

                    // Association du nouveau tag aux tags suivis
                    addSelectedTag(data['id'], $("#follow-choose-theme-zone").attr('addUrl'), '#follow-selected-theme-zone');

                    // Suppression de l'affichage
                    $("#follow-choose-theme").val('');
                    $("#follow-choose-theme-id").val('');
                }
            }
        });
    });



</script>
