{# Gestion code doublon / inscriptionStep3.html.twig > oui / non à mutualiser? #}
<script>
    // **************************** //
    //      Gestion des accents
    // **************************** //
    {% include 'PolitizrFrontBundle:JS:accentMap.js.twig' %}
    var normalize = function( term ) {
        var ret = "";
        for ( var i = 0; i < term.length; i++ ) {
            ret += accentMap[ term.charAt(i) ] || term.charAt(i);
        }
        return ret;
    };

    // **************************** //
    //      Initialisation
    // **************************** //
    $(document).ready(function () {
        // *************************************************** //
        //    Initialisation des données autocomplete
        // *************************************************** //

        var nbZones = {{ nbZones }};
        console.log('nbZones = '+nbZones);

        for (i = 1; i <= nbZones; i++ ) {
            var ptTagTypeId = $('#tagsZone-'+i).children('.tagsAttr').eq(0).attr('ptTagTypeId');
            console.log('ptTagTypeId = '+ptTagTypeId);

            $.ajax({
                type: 'POST',
                url: "{{ path('AdminGetPTags') }}",
                data: { 'ptTagTypeId': ptTagTypeId, 'zoneId': i },
                dataType: 'json',
                // context: $('#tagsZone-'+i),
                {% include 'PolitizrAdminBundle:Fragment:ajaxError.js.twig' %}
                success: function(data) {
                    if (data['error']) {
                        // TODO: refactoring admin pour intégrer la logique Twitter Bootstrap
                        $('#ajaxLoader').hide();
                        alert('Erreur / ' + data['error']);
                        // $('#notifErrorContent').html(data['error']);
                        // $('#alert-error').show();
                    } else {
                        var availableTags = [];
                        $.each( data['pTags'], function( key, val ) {
                            var item = [];
                            item['label'] = val.title;
                            item['value'] = val.id;

                            availableTags.push(item);
                        });

                        var zoneId = data['zoneId'];

                        // http://api.jqueryui.com/autocomplete/
                        $('#tagsZone-'+zoneId).children('.selectedTag').eq(0).autocomplete({
                        // $('.selectedTag').autocomplete({
                            source: function( request, response ) {
                                var matcher = new RegExp( $.ui.autocomplete.escapeRegex( request.term ), "i" );
                                response( $.grep( availableTags, function( value ) {
                                    value = value.label || value.value || value;
                                    return matcher.test( value ) || matcher.test( normalize( value ) );
                                }));
                            },
                            select: function (event, ui) {
                                event.preventDefault();

                                // Affichage de la sélection
                                $('#tagsZone-'+zoneId).children('.selectedTag').eq(0).val(ui.item.label);     // display the selected text
                                $('#tagsZone-'+zoneId).children('.selectedTagID').eq(0).val(ui.item.value);   // save selected id to hidden input
                            }
                        });
                    }
                }
            })
        }
    });

    // clic ajout nouveau tag
    $("body").on("click", ".addUserTag", function() {
        console.log('click .addUserTag');

        var pTagTitle = $(this).siblings('.selectedTag').eq(0).val();
        var pTagId = $(this).siblings('.selectedTagID').eq(0).val();
        var ptTagTypeId = $(this).siblings('.tagsAttr').eq(0).attr('ptTagTypeId');
        var objectId = $(this).siblings('.tagsAttr').eq(0).attr('objectId');
        var addUrl = $(this).siblings('.tagsAttr').eq(0).attr('addUrl');

        console.log('title = ' + pTagTitle);
        console.log('id = ' + pTagId);
        console.log('type = ' + ptTagTypeId);
        console.log('userId = ' + objectId);
        console.log('add url = ' + addUrl);

        tag = pTagTitle.trim();
        if (tag === '') {
            return false;
        }

        // Ajout du nouveau tag
        $.ajax({
            type: 'POST',
            url: addUrl,
            data: { 'pTagTitle': pTagTitle, 'pTagId': pTagId, 'ptTagTypeId': ptTagTypeId, 'objectId': objectId },
            dataType: 'json',
            {% include 'PolitizrAdminBundle:Fragment:ajaxError.js.twig' %}
            context: this,
            success: function(data) {
                if (data['error']) {
                    $('#ajaxLoader').hide();
                    $('#notifErrorContent').html(data['error']);
                    $('#notifError').show();
                } else {
                    $('#ajaxLoader').hide();

                    if (data['created']) {
                        // Association du nouveau tag aux tags suivis
                        $(this).siblings('.displayTagsZone').eq(0).append(data['htmlTag']);
                    }

                    // Init inputs tag
                    $(this).siblings('.selectedTag').eq(0).val('');
                    $(this).siblings('.selectedTagID').eq(0).val('');
                }
            }
        });
    });

    // clic suppression tag
    $("body").on("click", ".deleteTag", function() {
        console.log('click .deleteTag');

        var pTagId = $(this).attr('pTagId');
        var objectId = $(this).attr('objectId');;
        var deleteUrl = $(this).attr('deleteUrl');

        console.log('pTagId = ' + pTagId);
        console.log('objectId = ' + objectId);
        console.log('deleteUrl = ' + deleteUrl);

        $.ajax({
            type: 'POST',
            url: deleteUrl,
            data: { 'objectId': objectId, 'pTagId': pTagId },
            dataType: 'json',
            {% include 'PolitizrAdminBundle:Fragment:ajaxError.js.twig' %}
            context: $(this).parent(),
            success: function(data) {
                if (data['error']) {
                    $('#ajaxLoader').hide();
                    $('#notifErrorContent').html(data['error']);
                    $('#notifError').show();
                } else {
                    $('#ajaxLoader').hide();

                    $(this).remove();
                }
            }
        });
    });

</script>
